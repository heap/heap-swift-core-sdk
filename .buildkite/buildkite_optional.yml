# GENERATED BY TERRAFORM: /context/meta/terraform_modules/source_repo/
# DO NOT REMOVE/RENAME! EDIT CAUTIOUSLY!
#
# Build steps in this file do not block PR merges; they are "optional". Typically you
# will want to add steps to `buildkite_required.yml` instead.
#
# FOR LARGE REPOS, limit the contents to triggering other pipelines that do the
# actual work, so that this stays a clear overview of build fan-out using an
# instance of the heap/monorepo-diff plugin as needed.
#
# FOR SMALL REPOS, this file can directly contain build-steps.
---
steps:

  - label: "Deploy heap-swift-core-interfaces to S3"
    timeout_in_minutes: 10
    if: build.tag =~ /^interfaces\/[0-9]+\.[0-9]+\.[0-9]+(?:-[a-z]+\.[1-9][0-9]*)?$$/
    command:  "make interfaces_xcframework deploy_interfaces_to_s3"
    agents:
      queue: "macos"

  - label: "Push release tags to the public remote"
    key: "mirror_tag"
    timeout_in_minutes: 10
    if: build.tag =~ /^[0-9]+\.[0-9]+\.[0-9]+(?:-[a-z]+\.[1-9][0-9]*)?$$/
    command:  "make push_tag_to_public"
    agents:
      queue: "macos"

  - label: "Create GitHub release"
    depends_on: "mirror_tag"
    timeout_in_minutes: 10
    if: build.tag =~ /^[0-9]+\.[0-9]+\.[0-9]+$$/
    command:  "make publish_github_release_from_public_tag"
    agents:
      queue: "macos"

  - label: "Push the main branch to the public remote"
    timeout_in_minutes: 10
    if: build.branch =~ /^main$$/
    command:  "make push_branch_to_public"
    agents:
      queue: "macos"

  - label: "Deploy heap-swift-core-dynamic to S3"
    timeout_in_minutes: 10
    if: build.tag =~ /^[0-9]+\.[0-9]+\.[0-9]+(?:-[a-z]+\.[1-9][0-9]*)?$$/
    command:  "make dynamic_xcframework deploy_dynamic_to_s3"
    agents:
      queue: "macos"
